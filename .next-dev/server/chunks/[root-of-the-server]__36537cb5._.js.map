{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient({\n  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n})\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY,CAAC;IAC/D,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEA,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 80, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/src/app/api/dashboard/stats/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\n\nexport async function GET() {\n  try {\n    const now = new Date();\n    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n\n    // جلب الإحصائيات الأساسية\n    const [\n      totalProjects,\n      publishedProjects,\n      featuredProjects,\n      totalViews,\n      totalLikes,\n      totalComments,\n      recentViews,\n      pendingComments\n    ] = await Promise.all([\n      prisma.projects.count(),\n      prisma.projects.count({ where: { status: 'PUBLISHED' } }),\n      prisma.projects.count({ where: { featured: true } }),\n      prisma.projects.aggregate({ _sum: { views: true } }),\n      prisma.project_likes.count(),\n      prisma.comments.count({ where: { status: 'APPROVED' } }),\n      prisma.project_views.count({ where: { createdAt: { gte: sevenDaysAgo } } }),\n      prisma.comments.count({ where: { status: 'PENDING' } })\n    ]);\n\n    // اتجاهات 7 أيام\n    const last7Days = Array.from({ length: 7 }).map((_, idx) => {\n      const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (6 - idx));\n      const dayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (6 - idx) + 1);\n      return { dayStart, dayEnd };\n    });\n\n    const [viewsByDay, likesByDay, commentsByDay] = await Promise.all([\n      Promise.all(\n        last7Days.map(({ dayStart, dayEnd }) =>\n          prisma.project_views.count({ where: { createdAt: { gte: dayStart, lt: dayEnd } } })\n        )\n      ),\n      Promise.all(\n        last7Days.map(({ dayStart, dayEnd }) =>\n          prisma.project_likes.count({ where: { createdAt: { gte: dayStart, lt: dayEnd } } })\n        )\n      ),\n      Promise.all(\n        last7Days.map(({ dayStart, dayEnd }) =>\n          prisma.comments.count({ where: { createdAt: { gte: dayStart, lt: dayEnd }, status: 'APPROVED' } })\n        )\n      )\n    ]);\n\n    const trends = last7Days.map(({ dayStart }, i) => ({\n      date: dayStart.toISOString().slice(0, 10),\n      views: viewsByDay[i],\n      likes: likesByDay[i],\n      comments: commentsByDay[i]\n    }));\n\n    // مصادر الزيارات آخر 30 يوم\n    const sourcesGroup = await prisma.project_views.groupBy({\n      by: ['source'],\n      where: { createdAt: { gte: thirtyDaysAgo } },\n      _count: { source: true }\n    });\n    const sources = Object.fromEntries(sourcesGroup.map(s => [s.source || 'other', s._count.source]));\n\n    // أفضل المشاريع آخر 30 يوم (حسب المشاهدات)\n    const topViews = await prisma.project_views.groupBy({\n      by: ['projectId'],\n      where: { createdAt: { gte: thirtyDaysAgo } },\n      _count: { projectId: true },\n      orderBy: { _count: { projectId: 'desc' } },\n      take: 5\n    });\n    const topProjectIds = topViews.map(v => v.projectId);\n    const topProjectsRaw = topProjectIds.length\n      ? await prisma.projects.findMany({\n          where: { id: { in: topProjectIds } },\n          include: { media_items: { take: 1, orderBy: { order: 'asc' } } }\n        })\n      : [];\n    const topProjects = topViews.map(v => {\n      const p = topProjectsRaw.find(pr => pr.id === v.projectId);\n      return p\n        ? {\n            id: p.id,\n            title: p.title,\n            slug: p.slug,\n            cover: p.media_items?.[0]?.src || null,\n            views: v._count.projectId\n          }\n        : { id: v.projectId, title: 'مشروع', slug: v.projectId, cover: null, views: v._count.projectId };\n    });\n\n    // أحدث التعليقات\n    const recentComments = await prisma.comments.findMany({\n      orderBy: { createdAt: 'desc' },\n      take: 5,\n      include: { projects: { select: { id: true, title: true, slug: true } } }\n    });\n\n    // حساب معدل التفاعل\n    const totalInteractions = (totalLikes || 0) + (totalComments || 0);\n    const engagement = totalProjects > 0\n      ? Math.round((totalInteractions / totalProjects) * 100) / 100\n      : 0;\n\n    return NextResponse.json({\n      success: true,\n      stats: {\n        totalProjects,\n        publishedProjects,\n        totalViews: totalViews._sum.views || 0,\n        totalLikes: totalLikes || 0,\n        totalComments,\n        featuredProjects,\n        recentViews,\n        pendingComments,\n        engagement\n      },\n      trends,\n      sources,\n      topProjects,\n      recentComments: recentComments.map(c => ({\n        id: c.id,\n        name: c.name,\n        message: c.message,\n        rating: c.rating,\n        status: c.status,\n        createdAt: c.createdAt.toISOString(),\n        project: c.projects\n      }))\n    });\n\n  } catch (error) {\n    console.error('❌ خطأ في جلب الإحصائيات:', error);\n    return NextResponse.json(\n      {\n        error: 'حدث خطأ في جلب الإحصائيات',\n        stats: {\n          totalProjects: 0,\n          publishedProjects: 0,\n          totalViews: 0,\n          totalLikes: 0,\n          totalComments: 0,\n          featuredProjects: 0,\n          recentViews: 0,\n          pendingComments: 0,\n          engagement: 0\n        },\n        trends: [],\n        sources: {},\n        topProjects: [],\n        recentComments: []\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}